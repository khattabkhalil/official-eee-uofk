-- CRITICAL REPAIR SCRIPT FOR EEE UOFK PORTAL (VERSION 2)
-- Run this in your Supabase SQL Editor to fix 500 errors and missing columns.

-- 1. Drop the broken tables (Safe to run if you need to reset structure)
DROP TABLE IF EXISTS public.resources CASCADE;
DROP TABLE IF EXISTS public.announcements CASCADE;
DROP TABLE IF EXISTS public.questions CASCADE;
DROP TABLE IF EXISTS public.subject_statistics CASCADE;

-- 2. Recreate Resources Table
CREATE TABLE public.resources (
  id bigint generated by default as identity primary key,
  subject_id bigint references subjects(id) ON DELETE CASCADE,
  type text NOT NULL DEFAULT 'lecture',
  title_ar text NOT NULL,
  title_en text NOT NULL,
  description_ar text,
  description_en text,
  file_path text,
  file_url text,
  file_size bigint,
  file_type text,
  source text,
  is_active boolean DEFAULT true,
  added_by bigint references users(id) ON DELETE SET NULL,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 3. Recreate Announcements Table
CREATE TABLE public.announcements (
  id bigint generated by default as identity primary key,
  title_ar text NOT NULL,
  title_en text NOT NULL,
  content_ar text NOT NULL,
  content_en text NOT NULL,
  type text DEFAULT 'general',
  priority text DEFAULT 'medium',
  is_active boolean DEFAULT true,
  added_by bigint references users(id) ON DELETE SET NULL,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 4. Recreate Questions Table
CREATE TABLE public.questions (
  id bigint generated by default as identity primary key,
  subject_id bigint references subjects(id) ON DELETE CASCADE,
  topic_ar text,
  topic_en text,
  question_text_ar text NOT NULL,
  question_text_en text NOT NULL,
  answer_text_ar text,
  answer_text_en text,
  difficulty text DEFAULT 'medium',
  image_path text,
  added_by bigint references users(id) ON DELETE SET NULL,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 5. Recreate Statistics Table
CREATE TABLE public.subject_statistics (
  id uuid primary key default gen_random_uuid(),
  subject_id bigint references subjects(id) ON DELETE CASCADE UNIQUE,
  total_lectures int DEFAULT 0,
  total_assignments int DEFAULT 0,
  total_exams int DEFAULT 0,
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 6. Enable Public Access (RLS Policies)
ALTER TABLE public.resources ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.announcements ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.questions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.subject_statistics ENABLE ROW LEVEL SECURITY;

-- Reading Policies
CREATE POLICY "Public Read Access Resources" ON public.resources FOR SELECT USING (is_active = true);
CREATE POLICY "Public Read Access Announcements" ON public.announcements FOR SELECT USING (is_active = true);
CREATE POLICY "Public Read Access Questions" ON public.questions FOR SELECT USING (true);
CREATE POLICY "Public Read Access Statistics" ON public.subject_statistics FOR SELECT USING (true);

-- Admin Policies (Simplified for development)
CREATE POLICY "Admin All Access Resources" ON public.resources USING (true) WITH CHECK (true);
CREATE POLICY "Admin All Access Announcements" ON public.announcements USING (true) WITH CHECK (true);
CREATE POLICY "Admin All Access Questions" ON public.questions USING (true) WITH CHECK (true);
CREATE POLICY "Admin All Access Statistics" ON public.subject_statistics USING (true) WITH CHECK (true);

-- 7. Initialize Statistics for all subjects
INSERT INTO public.subject_statistics (subject_id)
SELECT id FROM public.subjects
ON CONFLICT (subject_id) DO NOTHING;

SELECT 'Schema repair complete! Please refresh your website.' as status;
